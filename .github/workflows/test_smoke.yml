name: Test Smoke

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'
      
jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: "Prepare system"
        run: |
          sudo apt-get update
          sudo apt-get -y dist-upgrade
          sudo apt-get -y remove containerd.io
      - name: "Install bot"
        env:
          PHILBOT_APPLICATION_ID: ${{ secrets.PHILBOT_APPLICATION_ID }}
          PHILBOT_API_TOKEN: ${{ secrets.PHILBOT_APPLICATION_ID }}
          PHILBOT_YOUTUBE_TOKEN: ${{ secrets.PHILBOT_YOUTUBE_TOKEN }}
          PHILBOT_OPENAI_TOKEN: ${{ secrets.PHILBOT_OPENAI_TOKEN }}
        run: |
          sudo apt-get install -y debconf-utils
          {
            echo philbot-config philbot/DEPLOYMENT select staging
            echo philbot-config philbot/DISCORD_CLIENT_ID string $PHILBOT_APPLICATION_ID
            echo philbot-config philbot/DISCORD_API_TOKEN string $PHILBOT_API_TOKEN
            echo philbot-config philbot/SELF_MONITORING select yes
            echo philbot-config philbot/OWNER_DISCORD_USER_ID string 305778551167254529
            echo philbot-config philbot/YOUTUBE_API_TOKEN string $PHILBOT_YOUTUBE_TOKEN
            echo philbot-config philbot/OPENAI_API_TOKEN string $PHILBOT_OPENAI_TOKEN
            echo philbot-config philbot/OPENAI_COST_LIMIT string 1
          } | sudo debconf-set-selections
          wget -O - https://raw.githubusercontent.com/plengauer/philbot/main/INSTALL.sh | sh -E
      - name: "Test Webserver"
        run: wget http://127.0.0.1/
      - name: "Test AI"
        run: exit 0
      - name: "Test Voice"
        run: exit 0
      - name: "Cleanup"
        run: |
          sudo apt-get -y remove philbot
          sudo apt-get -y auto-remove
          sudo apt-get -y auto-clean
